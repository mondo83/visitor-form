<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>来訪者受付フォーム</title>
  <style>
    :root {
      --primary-color: #006699;
      --bg-color: #f5f8fa;
      --card-bg: #fff;
      --border-radius: 8px;
      --spacing: 1rem;
    }
    * { box-sizing: border-box; }

    /* iOSの日本語入力対応 */
    input, textarea, select {
      -webkit-user-select: text;
      user-select: text;
      -webkit-appearance: none;
      appearance: none;
      font-size: 16px; /* 16pxより小さいとiOSがズームする */
    }

    body {
      margin: 0;
      padding: var(--spacing);
      background: var(--bg-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      -webkit-text-size-adjust: 100%;
    }
    main {
      max-width: 100%;
      width: 600px;
      margin: auto;
      background: var(--card-bg);
      padding: calc(var(--spacing) * 1.5);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow-x: hidden; /* はみ出し防止 */
    }

    /* 見出し */
    h1 {
      margin: 0 0 var(--spacing);
      text-align: center;
      background: var(--primary-color);
      color: #fff;
      padding: 0.75em;
      border-radius: var(--border-radius);
      font-size: 1.5rem;
      word-break: keep-all; /* 日本語の改行位置調整 */
    }
    #langSwitch {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: var(--spacing);
    }
    #langSwitch button {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.5em 1em; /* タップ領域拡大 */
    }

    .facility-display {
      text-align: center;
      margin-bottom: var(--spacing);
      color: var(--primary-color);
      font-weight: bold;
      word-break: break-all; /* 長い施設名の改行 */
    }
    label {
      display: block;
      margin-top: var(--spacing);
      font-weight: bold;
    }
    input, select, button {
      padding: 0.5em;
      margin-top: 0.25em;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px; /* iOSでのズーム防止 */
      max-width: 100%; /* はみ出し防止 */
    }
    
    /* iOSでの日付・時間入力対応 */
    input[type="date"], input[type="time"] {
      min-height: 44px; /* タップしやすさ向上 */
    }
    
    input, select { width: 100%; }
    button { width: 100%; }

    /* レスポンシブ対応強化 */
    .datetime-row { 
      display: flex; 
      flex-wrap: wrap; /* 狭い画面で折り返し */
      gap: 0.5em; 
      margin-top: var(--spacing); 
    }
    .datetime-field { 
      flex: 1 1 45%; /* 狭い画面では縦に並ぶようにする */
      min-width: 140px; 
    }

    .name-pair { 
      display: flex; 
      flex-wrap: wrap; /* 狭い画面で折り返し */
      gap: 0.5em; 
      margin-top: 0.5em; 
    }
    .name-pair input { 
      flex: 1 1 45%; 
      min-width: 120px; /* 最小幅を確保 */
    }

    .purpose-table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: var(--spacing); 
      table-layout: fixed; /* テーブルの幅固定 */
    }
    .purpose-table th { 
      text-align: left; 
      padding-bottom: 0.5em; 
      border-bottom: 1px solid #ddd; 
      font-weight: bold; 
    }
    .purpose-table td { 
      padding: 0.5em 0; /* タップ領域拡大 */
      vertical-align: middle; 
    }
    .purpose-table td:first-child { 
      width: 2em; 
      text-align: center; 
    }
    .purpose-table td:first-child input[type="checkbox"] {
      width: auto;
      transform: scale(1.2); /* タップしやすく、かつ表示を保持 */
    }
    .purpose-table td:nth-child(2) { 
      padding-left: 0.5em; 
      word-break: keep-all; /* 日本語の改行位置調整 */
    }

    .scroll-box { 
      max-height: 240px; 
      overflow-y: auto; 
      -webkit-overflow-scrolling: touch; /* iOSでのスムーズスクロール */
      background: #fafafa; 
      padding: 0.75em; 
      border: 1px solid #ddd; 
      border-radius: 4px; 
      white-space: normal; 
      margin-top: 0.5em; 
      font-size: 0.9rem; 
      line-height: 1.4; 
    }
    .scroll-box ul { 
      margin: 0; 
      padding-left: 1.2em; 
    }
    .scroll-box li { 
      margin-bottom: 0.5em; 
      overflow-wrap: break-word; /* 長い文章の折り返し */
      word-break: break-word;
    }

    .agree-container { 
      text-align: center; 
      margin-top: var(--spacing); 
    }
    .agree-text { 
      margin-bottom: 0.5em; 
      font-weight: bold; 
    }
    .agree-container input[type="checkbox"] { 
      width: auto; 
      display: block; 
      margin: 0 auto var(--spacing); 
      transform: scale(1.2); /* タップしやすくする */
    }

    .return-note { 
      text-align: center; 
      font-size: 0.9rem; 
      margin-top: 0.5em; 
    }

    .btn { 
      background: var(--primary-color); 
      color: #fff; 
      border: none; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-top: var(--spacing); 
      transition: background 0.2s; 
      min-height: 44px; /* タップしやすく */
    }
    .btn:disabled { 
      background: #aaa; 
      cursor: not-allowed; 
    }
    .btn:hover:enabled, .btn:active:enabled { 
      background: #00557a; 
    }

    .btn-small { 
      background: var(--primary-color); 
      color: #fff; 
      width: auto; 
      padding: 0.5em 1em; /* タップ領域拡大 */
      font-size: 0.9rem; 
      margin-top: 0.5em; 
      min-height: 44px; /* タップしやすく */
    }
    .btn-small:hover, .btn-small:active { 
      background: #00557a; 
    }

    #msg { 
      margin-top: var(--spacing); 
      text-align: center; 
      color: #d33; 
      font-weight: bold; 
      word-break: break-word; /* エラーメッセージの折り返し */
    }
    
    /* iOSでの表示問題解決のための追加スタイル */
    @supports (-webkit-touch-callout: none) {
      /* iOSデバイス向け特定対応 */
      input, select, textarea, button {
        font-size: 16px !important; /* ズーム防止のため */
      }
      
      /* フォーカス時の挙動改善 */
      input:focus, textarea:focus, select:focus {
        font-size: 16px !important;
        transform: scale(1);
      }
    }
  </style>
</head>
<body>
  <main>
    <h1 data-ja="来訪者受付フォーム" data-en="Visitor Check-in Form">来訪者受付フォーム</h1>
    <div id="langSwitch">
      <button type="button" onclick="setLang('ja')">日本語</button>
      <button type="button" onclick="setLang('en')">English</button>
    </div>

    <div id="facilityDisplay" class="facility-display">未設定</div>
    <input type="hidden" id="facility" name="facility" value="未設定">

    <form id="visitorForm">
      <div class="datetime-row">
        <div class="datetime-field">
          <label for="visitDate" data-ja="ご来所日" data-en="Date of Visit">ご来所日</label>
          <input type="date" id="visitDate" name="visitDate" required>
        </div>
        <div class="datetime-field">
          <label for="visitTime" data-ja="ご来所時間" data-en="Time of Arrival">ご来所時間</label>
          <input type="time" id="visitTime" name="visitTime" required>
        </div>
      </div>

      <label for="leaveTime" data-ja="予定ご退所時間" data-en="Expected Departure">予定ご退所時間</label>
      <input type="time" id="leaveTime" name="leaveTime">

      <label for="company" data-ja="貴社名（必須）" data-en="Company Name (required)">貴社名（必須）</label>
      <input type="text" id="company" name="company" autocomplete="organization" required>

      <label data-ja="お名前・ビジターカード番号" data-en="Name & Visitor Card No.">お名前・ビジターカード番号</label>
      <div id="nameSection"></div>
      <button type="button" class="btn-small" onclick="addNamePair()" data-ja="＋追加" data-en="+ Add">＋追加</button>

      <table class="purpose-table">
        <thead><tr><th></th><th data-ja="ご来所目的（複数選択可）" data-en="Purpose of Visit (multiple)">ご来所目的（複数選択可）</th></tr></thead>
        <tbody>
          <tr><td><input type="checkbox" name="purpose" value="調査・監査・見学"></td><td data-ja="調査・監査・見学" data-en="Inspection / Audit / Tour">調査・監査・見学</td></tr>
          <tr><td><input type="checkbox" name="purpose" value="打合せ"></td><td data-ja="打合せ（会議）" data-en="Meeting">打合せ（会議）</td></tr>
          <tr><td><input type="checkbox" name="purpose" value="納品・修理・清掃 他"></td><td data-ja="納品・修理・清掃 他" data-en="Delivery / Repair / Cleaning">納品・修理・清掃 他</td></tr>
        </tbody>
      </table>

      <label data-ja="【注意事項】（必読）" data-en="Notes (must read)">【注意事項】（必読）</label>
      <div class="scroll-box">
        <ul>
          <li data-ja="試験エリアには化学物質や有機溶媒が置かれています。それらに接触することにより眼や皮膚が障碍されたり、吸収されて健康被害を惹き起こす可能性があります。そのため、試験エリアに立ち入る際には肌の露出を避けた服装でご入室ください。また、化学物質等に接触の可能性が高い場合は保護具（マスク、ゴーグル、グローブ、白衣）を貸与いたしますので弊社社員にお申し付けください。" data-en="The testing area contains chemical substances and organic solvents that may harm eyes or skin upon contact and cause health issues. When entering the testing area, please wear clothing that avoids skin exposure. If there is a high risk of contact with chemicals, request protective equipment (mask, goggles, gloves, lab coat) from our staff.">試験エリアには化学物質や有機溶媒が置かれています。それらに接触することにより眼や皮膚が障碍されたり、吸収されて健康被害を惹き起こす可能性があります。そのため、試験エリアに立ち入る際には肌の露出を避けた服装でご入室ください。また、化学物質等に接触の可能性が高い場合は保護具（マスク、ゴーグル、グローブ、白衣）を貸与いたしますので弊社社員にお申し付けください。</li>
          <li data-ja="試験エリアには機器や設備が机上や足元に設置されています。それらに接触すると衣服が破れたり、怪我をする恐れがありますのでご注意願います。" data-en="Equipment and devices are installed on benches and floors in the testing area. Please be careful, as contacting them may tear clothing or cause injury.">試験エリアには機器や設備が机上や足元に設置されています。それらに接触すると衣服が破れたり、怪我をする恐れがありますのでご注意願います。</li>
          <li data-ja="試験エリアで作業される際には弊社の生産活動に支障をきたすことのないように安全には十分ご注意いただくとともに弊社社員の指示には必ず従っていただくようお願いします。" data-en="When working in the testing area, take all safety precautions to avoid disrupting our production activities and always follow the instructions of our staff.">試験エリアで作業される際には弊社の生産活動に支障をきたすことのないように安全には十分ご注意いただくとともに弊社社員の指示には必ず従っていただくようお願いします。</li>
          <li data-ja="サンプル（生体試料、原薬、製剤等）の保存エリアに立ち入る際は設置機器・設備の停止、誤操作、破損/汚損にご留意願います。異常発生時には速やかに弊署社員に連絡願います。また、本エリアの温度変動を最小限にするためドアの開閉は速やかにお願いします。" data-en="When entering the sample storage area (biological samples, APIs, formulations, etc.), be careful not to stop equipment incorrectly, operate it improperly, or cause damage/contamination. In case of any abnormality, contact our staff immediately. To minimize temperature deviations in this area, please open and close doors promptly.">サンプル（生体試料、原薬、製剤等）の保存エリアに立ち入る際は設置機器・設備の停止、誤操作、破損/汚損にご留意願います。異常発生時には速やかに弊署社員に連絡願います。また、本エリアの温度変動を最小限にするためドアの開閉は速やかにお願いします。</li>
          <li data-ja="急な発熱や体調不良が発生した場合は弊社社員への連絡をお願いします。また火災や災害時などの緊急時は弊社社員の指示に従って避難をお願いします。" data-en="If you experience sudden fever or feel unwell, please contact our staff. In case of fire or other emergencies, follow our staff's instructions for evacuation.">急な発熱や体調不良が発生した場合は弊社社員への連絡をお願いします。また火災や災害時などの緊急時は弊社社員の指示に従って避難をお願いします。</li>
          <li data-ja="施設内ではビジターカード(VC)をご着用願います。また指定場所以外での飲食はご遠慮願います。" data-en="Please wear your visitor card (VC) within the facility. Eating and drinking outside designated areas is prohibited.">施設内ではビジターカード(VC)をご着用願います。また指定場所以外での飲食はご遠慮願います。</li>
          <li data-ja="施設内で知り得た情報の第三者開示、写真撮影、動画撮影は禁止しますのでご了承願います。" data-en="Disclosure of information obtained within the facility to third parties, photography, and video recording are prohibited.">施設内で知り得た情報の第三者開示、写真撮影、動画撮影は禁止しますのでご了承願います。</li>
          <li data-ja="当方の一方的過失以外の事故などについては一切の責任を負いかねます。事故防止には万全を期していただくようお願い申し上げます。" data-en="We accept no liability for any incidents other than our sole negligence. Please take all necessary precautions to prevent accidents.">当方の一方的過失以外の事故などについては一切の責任を負いかねます。事故防止には万全を期していただくようお願い申し上げます。</li>
        </ul>
      </div>

      <div class="agree-container">
        <div class="agree-text" data-ja="上記注意事項を確認しました" data-en="I have read and agree to the above">上記注意事項を確認しました</div>
        <input type="checkbox" id="agree" name="agree">
      </div>

      <div class="return-note" data-ja="お帰りの際は、ビジターカードを受付に返却してください" data-en="Please return your visitor card to reception upon leaving.">お帰りの際は、ビジターカードを受付に返却してください</div>

      <button type="submit" id="submitBtn" class="btn" disabled data-ja="送信" data-en="Submit">送信</button>
    </form>
    <p id="msg"></p>
  </main>

  <script>
    let lang = 'ja';

    function setLang(l) {
      lang = l;
      document.querySelectorAll('[data-ja], [data-en]').forEach(el => {
        // データ属性がある要素だけ処理
        if(el.hasAttribute(`data-${l}`)) {
          el.textContent = el.getAttribute(`data-${l}`);
        }
        
        // プレースホルダー処理
        if (el.hasAttribute(`data-${l}-placeholder`)) {
          el.placeholder = el.getAttribute(`data-${l}-placeholder`);
        }
      });
      
      // 名前セクションのプレースホルダー更新
      document.querySelectorAll('#nameSection input').forEach(input => {
        if(input.name === 'visitorName[]') {
          input.placeholder = lang === 'en' ? 'Name' : 'お名前';
        } else if(input.name === 'visitorCard[]') {
          input.placeholder = lang === 'en' ? 'Card No.' : 'VC No.';
        }
      });
    }

    // フォーカス問題を単純化して解決
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (isIOS) {
      // 最初の読み込み時にビューポートを一度だけ設定
      const viewportMeta = document.querySelector('meta[name="viewport"]');
      viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no');
    }

    // 初期処理: 1行目もJavaScriptで追加
    window.addEventListener('DOMContentLoaded', () => {
      addNamePair();

      const now = new Date();
      document.getElementById('visitDate').value = now.toISOString().slice(0,10);
      
      // 時刻フォーマットを修正（Safari対応）
      let hours = now.getHours().toString().padStart(2, '0');
      let minutes = now.getMinutes().toString().padStart(2, '0');
      document.getElementById('visitTime').value = `${hours}:${minutes}`;

      try {
        const params = new URLSearchParams(location.search);
        const fac = params.get('facility') || '未設定';
        document.getElementById('facility').value = decodeURIComponent(fac);
        document.getElementById('facilityDisplay').textContent = decodeURIComponent(fac);
      } catch (e) {
        console.error('URLパラメータ処理エラー:', e);
        document.getElementById('facility').value = '未設定';
        document.getElementById('facilityDisplay').textContent = '未設定';
      }
      
      // iOS日本語入力サポート
      document.querySelectorAll('input[type="text"]').forEach(input => {
        // 日本語入力の問題を解決するための属性設定
        input.setAttribute('autocomplete', 'off');
        input.setAttribute('autocorrect', 'off');
        input.setAttribute('autocapitalize', 'off');
        input.setAttribute('spellcheck', 'false');

        // iOSでの動作を安定させるためのイベント処理
        input.addEventListener('focus', function() {
          // フォーカス時に属性を再設定（特にiOSで効果的）
          setTimeout(() => {
            this.setAttribute('autocomplete', 'off');
          }, 100);
        });
      });
    });

    function addNamePair() {
      const section = document.getElementById('nameSection');
      const count = section.querySelectorAll('.name-pair').length;
      if (count >= 5) {
        alert(lang==='en'? 'Up to 5 entries':'最大5名までです');
        return;
      }

      const div = document.createElement('div');
      div.className = 'name-pair';
      
      // HTMLを直接設定（iOSでの入力問題対応）
      div.innerHTML = `
        <input type="text"
               name="visitorName[]"
               lang="ja"
               placeholder="${lang==='en'?'Name':'お名前'}"
               data-ja-placeholder="お名前"
               data-en-placeholder="Name"
               autocomplete="name"
               autocapitalize="words"
               inputmode="text"
               required>
        <input type="text"
               name="visitorCard[]"
               placeholder="${lang==='en'?'Card No.':'VC No.'}"
               data-ja-placeholder="VC No."
               data-en-placeholder="Card No."
               inputmode="numeric"
               pattern="[0-9]*"
               required>
      `;
      section.appendChild(div);
    }

    document.getElementById('visitorForm').addEventListener('change', function(e) {
      document.getElementById('submitBtn').disabled = !document.getElementById('agree').checked;
    });
    
    // チェックボックスのタップエリアを拡大 - テーブル内のチェックボックスのみ対象
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.purpose-table input[type="checkbox"]').forEach(function(checkbox) {
        const parent = checkbox.closest('td').nextElementSibling; // ラベルセル
        if(parent) {
          parent.style.cursor = 'pointer';
          parent.addEventListener('click', function(e) {
            checkbox.checked = !checkbox.checked;
            // イベント発火
            const event = new Event('change', { bubbles: true });
            checkbox.dispatchEvent(event);
          });
        }
      });
    });
  </script>
</body>
</html>
