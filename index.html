<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>来訪者受付フォーム</title>
  <style>
    :root {
      --primary-color: #006699;
      --bg-color: #f5f8fa;
      --card-bg: #fff;
      --border-radius: 8px;
      --spacing: 1rem;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: var(--spacing);
      background: var(--bg-color);
      font-family: 'Helvetica Neue', Arial, sans-serif;
    }
    main {
      max-width: 600px;
      margin: auto;
      background: var(--card-bg);
      padding: calc(var(--spacing) * 1.5);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0 0 var(--spacing);
      text-align: center;
      color: var(--primary-color);
      font-size: 1.5rem;
    }
    #langSwitch {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: var(--spacing);
    }
    #langSwitch button {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      font-size: 0.9rem;
    }
    label { display: block; margin-top: var(--spacing); font-weight: bold; }
    input, select, button {
      width: 100%; padding: 0.5em; margin-top: 0.25em;
      border: 1px solid #ccc; border-radius: 4px;
      font-size: 1rem;
    }
    .name-pair { display: flex; gap: 0.5em; margin-top: 0.5em; }
    .name-pair input { flex: 1; }
    .purpose-table {
      width: 100%; border-collapse: collapse; margin-top: var(--spacing);
    }
    .purpose-table th {
      text-align: left; padding-bottom: 0.5em;
      border-bottom: 1px solid #ddd; font-weight: bold;
    }
    .purpose-table td {
      padding: 0.25em 0; vertical-align: middle;
    }
    .purpose-table td:first-child { width: 2em; }
    .purpose-table td:nth-child(2) { padding-left: 0.5em; }
    .scroll-box {
      max-height: 240px; overflow-y: auto;
      background: #fafafa; padding: 0.75em;
      border: 1px solid #ddd; border-radius: 4px;
      white-space: normal; margin-top: 0.5em;
      font-size: 0.9rem; line-height: 1.4;
    }
    .scroll-box ul { margin: 0; padding-left: 1.2em; }
    .scroll-box li { margin-bottom: 0.5em; }
    .agree-container {
      text-align: center; margin-top: var(--spacing);
    }
    .agree-text { margin-bottom: 0.5em; font-weight: bold; }
    .agree-container input[type="checkbox"] {
      width: auto;
      display: block;
      margin: 0 auto var(--spacing);
      transform: scale(1.2);
    }
    .btn {
      background: var(--primary-color); color: #fff;
      border: none; cursor: pointer;
      font-size: 1rem; margin-top: var(--spacing);
      transition: background 0.2s;
    }
    .btn:disabled {
      background: #aaa; cursor: not-allowed;
    }
    .btn:hover:enabled { background: #00557a; }
    .btn-small {
      width: auto; padding: 0.5em; font-size: 0.9rem;
      margin-top: 0.5em;
    }
    #msg {
      margin-top: var(--spacing);
      text-align: center;
      color: #d33;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <main>
    <h1 data-ja="来訪者受付フォーム" data-en="Visitor Check-in Form">来訪者受付フォーム</h1>
    <div id="langSwitch">
      <button type="button" onclick="setLang('ja')">日本語</button>
      <button type="button" onclick="setLang('en')">English</button>
    </div>
    <form id="visitorForm">
      <!-- 施設名 -->
      <label for="facilityDisplay" data-ja="施設名" data-en="Facility">施設名</label>
      <div id="facilityDisplay" style="padding: 0.5em; background-color: #f0f0f0; border-radius: 4px; border: 1px solid #ccc; margin-top: 0.25em;">未設定</div>
      <input type="hidden" id="facility" name="facility" value="未設定">
      <!-- ご来所日 -->
      <label for="visitDate" data-ja="ご来所日" data-en="Date of Visit">ご来所日</label>
      <input type="date" id="visitDate" name="visitDate" required>
      <!-- ご来所時間 -->
      <label for="visitTime" data-ja="ご来所時間" data-en="Time of Arrival">ご来所時間</label>
      <input type="time" id="visitTime" name="visitTime" required>
      <!-- 予定ご退所時間 -->
      <label for="leaveTime" data-ja="予定ご退所時間" data-en="Expected Departure">予定ご退所時間</label>
      <input type="time" id="leaveTime" name="leaveTime">
      <!-- 貴社名 -->
      <label for="company" data-ja="貴社名（必須）" data-en="Company Name (required)">貴社名（必須）</label>
      <input type="text" id="company" name="company" required>
      <!-- お名前・VC -->
      <label data-ja="お名前・ビジターカード番号" data-en="Name & Visitor Card No.">お名前・ビジターカード番号</label>
      <div id="nameSection">
        <div class="name-pair">
          <input type="text" placeholder="お名前" data-en-placeholder="Name" required>
          <input type="number" placeholder="VC No." data-en-placeholder="Card No." required>
        </div>
      </div>
      <button type="button" class="btn btn-small" onclick="addNamePair()" data-ja="＋追加" data-en="+ Add">＋追加</button>
      <!-- ご来所目的 -->
      <table class="purpose-table">
        <thead>
          <tr>
            <th></th>
            <th data-ja="ご来所目的（複数選択可）" data-en="Purpose of Visit (multiple)">ご来所目的（複数選択可）</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="checkbox" name="purpose" value="調査・監査・見学"></td>
            <td data-ja="調査・監査・見学" data-en="Inspection / Audit / Tour">調査・監査・見学</td>
          </tr>
          <tr>
            <td><input type="checkbox" name="purpose" value="打合せ"></td>
            <td data-ja="打合せ（会議）" data-en="Meeting">打合せ（会議）</td>
          </tr>
          <tr>
            <td><input type="checkbox" name="purpose" value="納品・修理・清掃 他"></td>
            <td data-ja="納品・修理・清掃 他" data-en="Delivery / Repair / Cleaning">納品・修理・清掃 他</td>
          </tr>
        </tbody>
      </table>
      <!-- 注意事項 -->
      <label data-ja="【注意事項】（必読）" data-en="Notes (must read)">【注意事項】（必読）</label>
      <div class="scroll-box">
        <ul>
          <li data-ja="試験エリアには化学物質や有機溶媒が置かれています。それらに接触することにより眼や皮膚が障害されたり、吸収されて健康被害を惹き起こす可能性があります。そのため、試験エリアに立ち入る際には、肌の露出を避ける服装でご入室してください。また、化学物質等に接触の可能性が高い場合は保護具（マスク、ゴーグル、グローブ、白衣）を貸与致しますので、弊社社員にお申し付けください。"
              data-en="The testing area contains chemical substances and organic solvents that may harm eyes or skin upon contact and cause health issues. When entering the testing area, please wear clothing that avoids skin exposure. If there is a high risk of contact with chemicals, request protective equipment (mask, goggles, gloves, lab coat) from our staff.">試験エリアには化学物質や有機溶媒が置かれています。それらに接触することにより眼や皮膚が障害されたり、吸収されて健康被害を惹き起こす可能性があります。そのため、試験エリアに立ち入る際には、肌の露出を避ける服装でご入室してください。また、化学物質等に接触の可能性が高い場合は保護具（マスク、ゴーグル、グローブ、白衣）を貸与致しますので、弊社社員にお申し付けください。</li>
          <li data-ja="試験エリアには機器や設備が机上や足元に設置されています。それらに接触すると衣服が破れたり、けがをする恐れがありますのでご注意願います。"
              data-en="Equipment and devices are installed on benches and floors in the testing area. Please be careful, as contacting them may tear clothing or cause injury.">試験エリアには機器や設備が机上や足元に設置されています。それらに接触すると衣服が破れたり、けがをする恐れがありますのでご注意願います。</li>
          <li data-ja="試験エリアで作業される際には、弊社の生産活動に支障をきたすことのないように安全には十分ご注意いただくとともに、弊社社員の指示には必ず従っていただきますようお願いします。"
              data-en="When working in the testing area, take all safety precautions to avoid disrupting our production activities and always follow the instructions of our staff.">試験エリアで作業される際には、弊社の生産活動に支障をきたすことのないように安全には十分ご注意いただくとともに、弊社社員の指示には必ず従っていただきますようお願いします。</li>
          <li data-ja="サンプル（生体試料、原薬、製剤等）の保存エリアに立ち入る際は、設置機器・設備の停止、誤操作、破損/汚損にご留意願います。異常発生時には速やかに弊社社員に連絡願います。また、本エリアの温度変動を最小限にするため、ドアの開閉は速やかにお願いします。"
              data-en="When entering the sample storage area (biological samples, APIs, formulations, etc.), be careful not to stop equipment incorrectly, operate it improperly, or cause damage/contamination. In case of any abnormality, contact our staff immediately. To minimize temperature fluctuations in this area, please open and close doors quickly.">サンプル（生体試料、原薬、製剤等）の保存エリアに立ち入る際は、設置機器・設備の停止、誤操作、破損/汚損にご留意願います。異常発生時には速やかに弊社社員に連絡願います。また、本エリアの温度変動を最小限にするため、ドアの開閉は速やかにお願いします。</li>
          <li data-ja="急な発熱や体調不良が発生した場合は弊社社員への連絡をお願いします。また、火災や災害時などの緊急時は弊社社員の指示に従って避難をお願いします。"
              data-en="If you experience sudden fever or feel unwell, please contact our staff. In case of fire or other emergencies, follow our staff's instructions for evacuation.">急な発熱や体調不良が発生した場合は弊社社員への連絡をお願いします。また、火災や災害時などの緊急時は弊社社員の指示に従って避難をお願いします。</li>
          <li data-ja="施設内ではビジターカード(VC)をご着用願います。また、指定場所以外での飲食はご遠慮願います。"
              data-en="Please wear your visitor card (VC) within the facility. Eating and drinking outside designated areas is prohibited.">施設内ではビジターカード(VC)をご着用願います。また、指定場所以外での飲食はご遠慮願います。</li>
          <li data-ja="施設内で知り得た情報の第三者開示、写真撮影、動画撮影は禁止しますのでご了承願います。"
              data-en="Disclosure of information obtained within the facility to third parties, photography, and video recording are prohibited.">施設内で知り得た情報の第三者開示、写真撮影、動画撮影は禁止しますのでご了承願います。</li>
          <li data-ja="当方の一方的過失以外の事故などについては、一切の責任を負いかねます。事故防止には万全を期していただくようお願い申し上げます。"
              data-en="We accept no liability for any incidents other than our sole negligence. Please take all necessary precautions to prevent accidents.">当方の一方的過失以外の事故などについては、一切の責任を負いかねます。事故防止には万全を期していただくようお願い申し上げます。</li>
        </ul>
      </div>
      <!-- 同意チェック -->
      <div class="agree-container">
        <div class="agree-text" data-ja="上記注意事項を確認しました" data-en="I have read and agree to the above">上記注意事項を確認しました</div>
        <input type="checkbox" id="agree" name="agree">
      </div>
      <!-- 送信ボタン -->
      <button type="submit" id="submitBtn" class="btn" disabled data-ja="送信" data-en="Submit">送信</button>
    </form>
    <p id="msg"></p>
  </main>

  <script>
    // URLパラメータからfacility取得
    const urlParams = new URLSearchParams(location.search);
    const fac = urlParams.get('facility') || '未設定';
    document.getElementById('facility').value = decodeURIComponent(fac);
    document.getElementById('facilityDisplay').textContent = decodeURIComponent(fac);

    // 初期値セット
    const now = new Date();
    document.getElementById('visitDate').value = now.toISOString().slice(0,10);
    document.getElementById('visitTime').value = now.toTimeString().slice(0,5);

    // 名前＋VC追加
    function addNamePair() {
      const section = document.getElementById('nameSection');
      const count = section.querySelectorAll('.name-pair').length;
      if (count >= 5) return alert(lang==='en' ? 'Up to 5 entries' : '最大5名までです');
      const div = document.createElement('div');
      div.className = 'name-pair';
      div.innerHTML = `
        <input type="text" placeholder="${lang==='en'?'Name':'お名前'}" required>
        <input type="number" placeholder="${lang==='en'?'Card No.':'VC No.'}" required>
      `;
      section.appendChild(div);
    }

    // 同意チェックで送信ボタン制御
    const agreeChk = document.getElementById('agree');
    const submitBtn = document.getElementById('submitBtn');
    agreeChk.addEventListener('change', () => {
      submitBtn.disabled = !agreeChk.checked;
    });

    // フォーム送信
    document.getElementById('visitorForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fields = {};
      ['facility','visitDate','visitTime','leaveTime','company'].forEach(id =>
        fields[id] = document.getElementById(id).value
      );
      document.querySelectorAll('.name-pair').forEach((pair,i) => {
        fields[`name_${i+1}`] = pair.children[0].value.trim();
        fields[`vc_${i+1}`]   = pair.children[1].value.trim();
      });
      fields.purpose = [...document.querySelectorAll('input[name="purpose"]:checked')]
        .map(el => el.value);
      fields.agree = agreeChk.checked;

      try {
        const res = await fetch('/.netlify/functions/submit', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(fields)
        });
        const result = await res.json();
        document.getElementById('msg').textContent =
          res.ok
            ? (lang==='en'?'Submission successful. Thank you.':'送信が完了しました。ありがとうございました。')
            : (lang==='en'?'Error: ':'エラー：') + result.message;
        if(res.ok) e.target.reset();
      } catch(err) {
        document.getElementById('msg').textContent =
          (lang==='en'?'Submission failed: ':'送信エラー：') + err.message;
      }
    });

    // 言語切替
    let lang = 'ja';
    function setLang(l) {
      lang = l;
      document.querySelectorAll('[data-ja]').forEach(el => {
        const txt = el.dataset[l];
        if (!txt) return;
        if (el.tagName==='INPUT' || el.tagName==='BUTTON') {
          if (el.hasAttribute('value')) el.value = txt;
          else if (el.placeholder) el.placeholder = el.dataset[l+'-placeholder'] || el.placeholder;
        } else {
          el.textContent = txt;
        }
      });
    }
  </script>
</body>
</html>
