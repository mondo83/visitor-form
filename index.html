<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>入退館フォーム</title>
  <!-- html5-qrcode CDN -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root {
      --main-bg: #f9f9f9;
      --main-color: #222;
      --accent: #1976d2;
      --danger: #e53935;
      --border: #ddd;
      --radius: 8px;
      --max-width: 480px;
    }
    body {
      background: var(--main-bg);
      color: var(--main-color);
      font-family: 'Segoe UI', 'Hiragino Sans', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 24px 8px 40px 8px;
      background: #fff;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      margin-top: 32px;
    }
    .center {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 48px;
    }
    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      padding: 18px 0;
      font-size: 1.2rem;
      width: 90%;
      margin: 12px 0;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .btn:active, .btn:focus {
      background: #12549b;
    }
    .lang-switch {
      position: absolute;
      top: 18px;
      right: 18px;
      color: var(--accent);
      cursor: pointer;
      font-weight: bold;
      text-decoration: underline;
      font-size: 1rem;
      z-index: 20;
    }
    h1 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 12px;
    }
    form {
      margin-top: 12px;
    }
    .form-group {
      margin-bottom: 18px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
    }
    input[type="text"], input[type="datetime-local"], input[type="time"], textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
      box-sizing: border-box;
      background: #fafbfc;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .checkbox-label {
      margin-right: 12px;
      font-size: 0.98rem;
    }
    .notice {
      background: #f1f8e9;
      border-left: 4px solid var(--accent);
      padding: 10px 12px;
      margin-bottom: 10px;
      border-radius: var(--radius);
      font-size: 0.98rem;
      white-space: pre-line;
    }
    .qr-section {
      margin: 20px 0;
      text-align: center;
    }
    .readonly {
      background: #eee;
      color: #888;
      border: 1px solid #ccc;
    }
    .error {
      color: var(--danger);
      margin-bottom: 12px;
      font-size: 1rem;
      text-align: center;
    }
    .success {
      color: #388e3c;
      margin-bottom: 12px;
      font-size: 1rem;
      text-align: center;
    }
    @media (max-width: 600px) {
      .container {
        max-width: 100vw;
        margin-top: 0;
        border-radius: 0;
        box-shadow: none;
        padding: 12px 2vw 40px 2vw;
      }
      .btn {
        width: 100%;
      }
      .lang-switch {
        right: 10px;
        top: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="lang-switch" id="lang-switch">English</div>
  <div class="container" id="main-container">
    <!-- Dynamic content will be rendered here -->
  </div>
  <script>
    // --- 多言語辞書 ---
    const i18n = {
      ja: {
        title: "入退館フォーム",
        entry: "これから入館する方",
        exit: "これで退館する方",
        name: "氏名",
        company: "会社名",
        visitDatetime: "来館日時",
        exitPlan: "退館予定時刻",
        visitPurpose: "来訪目的",
        purposes: [
          "打ち合わせ", "納品", "点検", "面接", "その他"
        ],
        notice: `【注意事項】
・館内では必ずビジターカードを携帯してください。
・退館時は必ず本フォームから手続きを行ってください。
・不明点があれば受付にお尋ねください。`,
        noticeAgree: "注意事項を読み、同意します",
        qrRead: "ビジターカードのQRコードを読み取ってください",
        qrReading: "QRコード読み取り中...",
        qrReadAgain: "再度QRコードを読み取る",
        qrReadSuccess: "読み取り成功: ",
        cardNumber: "ビジターカード番号",
        submit: "送信",
        submitting: "送信中...",
        sent: "送信が完了しました。ご来館ありがとうございます。",
        exitQr: "退館するビジターカードのQRコードを読み取ってください",
        exitProcessing: "退館処理中...",
        exitSuccess: "退館処理が完了しました。ご利用ありがとうございました。",
        exitNotFound: "該当する入館中の記録が見つかりません。",
        agreeRequired: "注意事項への同意が必要です。",
        required: "必須項目です",
        fieldRequired: "を入力してください",
        error: "エラーが発生しました。再度お試しください。",
        back: "戻る",
        lang: "English"
      },
      en: {
        title: "Entry/Exit Form",
        entry: "Entry",
        exit: "Exit",
        name: "Name",
        company: "Company",
        visitDatetime: "Visit Date & Time",
        exitPlan: "Planned Exit Time",
        visitPurpose: "Purpose of Visit",
        purposes: [
          "Meeting", "Delivery", "Inspection", "Interview", "Other"
        ],
        notice: `【Notice】
・Please always carry your visitor card inside the building.
・Be sure to complete the exit procedure via this form when leaving.
・If you have any questions, please ask at the reception.`,
        noticeAgree: "I have read and agree to the notice",
        qrRead: "Please scan the QR code on your visitor card",
        qrReading: "Scanning QR code...",
        qrReadAgain: "Scan QR code again",
        qrReadSuccess: "Scan Success: ",
        cardNumber: "Visitor Card Number",
        submit: "Submit",
        submitting: "Submitting...",
        sent: "Submission completed. Thank you for your visit.",
        exitQr: "Please scan the QR code of the visitor card to exit",
        exitProcessing: "Processing exit...",
        exitSuccess: "Exit completed. Thank you for your visit.",
        exitNotFound: "No matching entry record found.",
        agreeRequired: "You must agree to the notice.",
        required: "Required",
        fieldRequired: "is required.",
        error: "An error occurred. Please try again.",
        back: "Back",
        lang: "日本語"
      }
    };

    // --- 設定値（本番では外部関数で分離推奨） ---
    const KINTONE_DOMAIN = 'YOUR_SUBDOMAIN.cybozu.com'; // 例: example.cybozu.com
    const KINTONE_APP_ID = 'YOUR_APP_ID'; // kintoneアプリID
    const KINTONE_API_TOKEN = 'YOUR_API_TOKEN'; // APIトークン（本番では外部関数で分離推奨）
    const CARD_FIELD = 'visitor_card'; // ビジターカード番号のフィールドコード
    const STATUS_FIELD = 'status'; // ステータスのフィールドコード
    const EXIT_DATETIME_FIELD = 'exit_datetime'; // 退館日時のフィールドコード

    // --- 状態管理 ---
    let currentLang = 'ja';
    let html5QrCodeScanner = null;

    // --- 多言語切替 ---
    document.getElementById('lang-switch').addEventListener('click', () => {
      currentLang = currentLang === 'ja' ? 'en' : 'ja';
      renderTop();
    });

    // --- 初期表示 ---
    renderTop();

    // --- トップ画面 ---
    function renderTop() {
      document.documentElement.lang = currentLang;
      document.getElementById('lang-switch').textContent = i18n[currentLang].lang;
      document.getElementById('main-container').innerHTML = `
        <h1>${i18n[currentLang].title}</h1>
        <div class="center">
          <button class="btn" id="entry-btn">${i18n[currentLang].entry}</button>
          <button class="btn" id="exit-btn">${i18n[currentLang].exit}</button>
        </div>
      `;
      document.getElementById('entry-btn').onclick = renderEntryForm;
      document.getElementById('exit-btn').onclick = renderExitQr;
    }

    // --- 入館フォーム ---
    function renderEntryForm() {
      const now = new Date();
      const dtStr = now.toISOString().slice(0,16); // yyyy-MM-ddTHH:mm
      const purposes = i18n[currentLang].purposes;
      document.getElementById('main-container').innerHTML = `
        <h1>${i18n[currentLang].entry}</h1>
        <form id="entry-form" autocomplete="off">
          <div class="form-group">
            <label for="name">${i18n[currentLang].name} <span style="color:#e53935">*</span></label>
            <input type="text" id="name" name="name" required>
          </div>
          <div class="form-group">
            <label for="company">${i18n[currentLang].company} <span style="color:#e53935">*</span></label>
            <input type="text" id="company" name="company" required>
          </div>
          <div class="form-group">
            <label for="visit-datetime">${i18n[currentLang].visitDatetime} <span style="color:#e53935">*</span></label>
            <input type="datetime-local" id="visit-datetime" name="visit-datetime" value="${dtStr}" required>
          </div>
          <div class="form-group">
            <label for="exit-plan">${i18n[currentLang].exitPlan} <span style="color:#e53935">*</span></label>
            <input type="time" id="exit-plan" name="exit-plan" required>
          </div>
          <div class="form-group">
            <label>${i18n[currentLang].visitPurpose} <span style="color:#e53935">*</span></label>
            <div class="checkbox-group" id="purpose-group">
              ${purposes.map((p,i)=>`
                <label class="checkbox-label">
                  <input type="checkbox" name="purpose" value="${p}"> ${p}
                </label>
              `).join('')}
            </div>
          </div>
          <div class="form-group">
            <div class="notice" id="notice-text">${i18n[currentLang].notice}</div>
            <label>
              <input type="checkbox" id="agree" required>
              ${i18n[currentLang].noticeAgree}
            </label>
          </div>
          <div class="form-group qr-section">
            <div id="qr-area">
              <button type="button" class="btn" id="qr-btn">${i18n[currentLang].qrRead}</button>
              <div id="qr-reader" style="display:none; width:100%"></div>
              <div id="qr-result" style="margin-top:8px;"></div>
            </div>
            <label for="card-number">${i18n[currentLang].cardNumber} <span style="color:#e53935">*</span></label>
            <input type="text" id="card-number" name="card-number" class="readonly" readonly required>
          </div>
          <div id="entry-error" class="error" style="display:none;"></div>
          <button type="submit" class="btn">${i18n[currentLang].submit}</button>
          <button type="button" class="btn" style="background:#eee;color:#222;" id="back-btn">${i18n[currentLang].back}</button>
        </form>
      `;
      document.getElementById('qr-btn').onclick = startQrScanEntry;
      document.getElementById('back-btn').onclick = renderTop;
      document.getElementById('entry-form').onsubmit = submitEntryForm;
    }

    // --- QRコード読み取り（入館） ---
    function startQrScanEntry() {
      const qrReaderDiv = document.getElementById('qr-reader');
      qrReaderDiv.style.display = '';
      document.getElementById('qr-btn').style.display = 'none';
      document.getElementById('qr-result').textContent = i18n[currentLang].qrReading;
      if (html5QrCodeScanner) html5QrCodeScanner.clear();
      html5QrCodeScanner = new Html5Qrcode("qr-reader");
      html5QrCodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 200 },
        (decodedText) => {
          document.getElementById('card-number').value = decodedText;
          document.getElementById('qr-result').textContent = i18n[currentLang].qrReadSuccess + decodedText;
          html5QrCodeScanner.stop().then(() => {
            qrReaderDiv.style.display = 'none';
            document.getElementById('qr-btn').textContent = i18n[currentLang].qrReadAgain;
            document.getElementById('qr-btn').style.display = '';
          });
        },
        (error) => { /* ignore scan errors */ }
      );
    }

    // --- 入館フォーム送信 ---
    async function submitEntryForm(e) {
      e.preventDefault();
      // バリデーション
      const lang = i18n[currentLang];
      const name = document.getElementById('name').value.trim();
      const company = document.getElementById('company').value.trim();
      const visitDatetime = document.getElementById('visit-datetime').value;
      const exitPlan = document.getElementById('exit-plan').value;
      const purposes = Array.from(document.querySelectorAll('input[name="purpose"]:checked')).map(el=>el.value);
      const agree = document.getElementById('agree').checked;
      const cardNumber = document.getElementById('card-number').value.trim();
      const errorDiv = document.getElementById('entry-error');
      if (!name || !company || !visitDatetime || !exitPlan || !purposes.length || !agree || !cardNumber) {
        errorDiv.textContent = lang.error;
        errorDiv.style.display = '';
        return;
      }
      errorDiv.style.display = 'none';
      // 送信中UI
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = lang.submitting;

      // kintone API送信
      try {
        const record = {
          name: { value: name },
          company: { value: company },
          visit_datetime: { value: visitDatetime },
          exit_plan: { value: exitPlan },
          purpose: { value: purposes.join(', ') },
          notice_agree: { value: agree ? '同意' : '未同意' },
          [CARD_FIELD]: { value: cardNumber },
          [STATUS_FIELD]: { value: '入館中' }
        };
        await kintoneAddRecord(record);
        e.target.innerHTML = `<div class="success">${lang.sent}</div>
          <button type="button" class="btn" id="back-btn">${lang.back}</button>`;
        document.getElementById('back-btn').onclick = renderTop;
      } catch (err) {
        errorDiv.textContent = lang.error;
        errorDiv.style.display = '';
        submitBtn.disabled = false;
        submitBtn.textContent = lang.submit;
      }
    }

    // --- 退館QRコード画面 ---
    function renderExitQr() {
      document.getElementById('main-container').innerHTML = `
        <h1>${i18n[currentLang].exit}</h1>
        <div class="qr-section">
          <div id="qr-reader"></div>
          <div id="qr-result" style="margin-top:8px;"></div>
        </div>
        <div id="exit-error" class="error" style="display:none;"></div>
        <button type="button" class="btn" style="background:#eee;color:#222;" id="back-btn">${i18n[currentLang].back}</button>
      `;
      document.getElementById('back-btn').onclick = renderTop;
      startQrScanExit();
    }

    // --- QRコード読み取り（退館） ---
    function startQrScanExit() {
      const qrReaderDiv = document.getElementById('qr-reader');
      const resultDiv = document.getElementById('qr-result');
      if (html5QrCodeScanner) html5QrCodeScanner.clear();
      html5QrCodeScanner = new Html5Qrcode("qr-reader");
      resultDiv.textContent = i18n[currentLang].qrReading;
      html5QrCodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 200 },
        async (decodedText) => {
          resultDiv.textContent = i18n[currentLang].qrReadSuccess + decodedText;
          html5QrCodeScanner.stop();
          await processExit(decodedText);
        },
        (error) => { /* ignore scan errors */ }
      );
    }

    // --- 退館処理 ---
    async function processExit(cardNumber) {
      const lang = i18n[currentLang];
      const errorDiv = document.getElementById('exit-error');
      errorDiv.style.display = 'none';
      document.getElementById('qr-result').textContent = lang.exitProcessing;
      try {
        // 入館中のレコード検索
        const record = await kintoneFindEntryRecord(cardNumber);
        if (!record) {
          errorDiv.textContent = lang.exitNotFound;
          errorDiv.style.display = '';
          return;
        }
        // ステータス・退館時刻更新
        await kintoneUpdateRecord(record.$id.value, {
          [STATUS_FIELD]: { value: '退館' },
          [EXIT_DATETIME_FIELD]: { value: new Date().toISOString() }
        });
        document.getElementById('main-container').innerHTML = `
          <div class="success">${lang.exitSuccess}</div>
          <button type="button" class="btn" id="back-btn">${lang.back}</button>
        `;
        document.getElementById('back-btn').onclick = renderTop;
      } catch (err) {
        errorDiv.textContent = lang.error;
        errorDiv.style.display = '';
      }
    }

    // --- kintone API: レコード追加 ---
    async function kintoneAddRecord(record) {
      const url = `https://${KINTONE_DOMAIN}/k/v1/record.json`;
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Cybozu-API-Token': KINTONE_API_TOKEN
        },
        body: JSON.stringify({
          app: KINTONE_APP_ID,
          record
        })
      });
      if (!res.ok) throw new Error('kintone add error');
      return await res.json();
    }

    // --- kintone API: レコード検索 ---
    async function kintoneFindEntryRecord(cardNumber) {
      const url = `https://${KINTONE_DOMAIN}/k/v1/records.json?app=${KINTONE_APP_ID}&query=${encodeURIComponent(`${CARD_FIELD} = "${cardNumber}" and ${STATUS_FIELD} = "入館中"`)}`;
      const res = await fetch(url, {
        headers: { 'X-Cybozu-API-Token': KINTONE_API_TOKEN }
      });
      if (!res.ok) throw new Error('kintone find error');
      const data = await res.json();
      return data.records && data.records.length > 0 ? data.records[0] : null;
    }

    // --- kintone API: レコード更新 ---
    async function kintoneUpdateRecord(recordId, updateObj) {
      const url = `https://${KINTONE_DOMAIN}/k/v1/record.json`;
      const res = await fetch(url, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Cybozu-API-Token': KINTONE_API_TOKEN
        },
        body: JSON.stringify({
          app: KINTONE_APP_ID,
          id: recordId,
          record: updateObj
        })
      });
      if (!res.ok) throw new Error('kintone update error');
      return await res.json();
    }

    // --- 言語切替時の再描画 ---
    window.addEventListener('popstate', () => renderTop());
  </script>
</body>
</html>
